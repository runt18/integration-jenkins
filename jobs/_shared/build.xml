<?xml version="1.0" encoding="UTF-8" ?>
<!--
	ant build file for MediaWiki Core continuous integration
-->
<project name="MediaWiki" default="build">

	<!-- Import environnement: -->
	<property environment="env" />

	<property name="phpunitexcludes" value="Broken,ParserFuzz,Stub" />

	<!-- Import generic settings and validate existance -->

	<!-- private.properties for password. it is in .gitignore -->
	<property file="private.properties" />

	<!-- job.properties file is at the job level. Useful to override generic
		 properties -->
	<property file="job.properties" />

	<!-- then load the default.properties, setting any values which have not been
	     set previously -->
	<property file="default.properties" />

	<fail unless="sourcedir">You must define sourcedir</fail>
	<fail unless="builddir" >You must define builddir</fail>

	<!-- ant -Dmw.database=sqlite -->
	<target name="select-database" unless="mw.database">
		<input
			message      = "Select a database backend or set mw.database in local.properties"
			validargs    = "sqlite, postgre, mysql"
			defaultvalue = "sqlite"
			addproperty  = "mw.database"
		/>
	</target>
	<target name="select-branch" unless="mw.branch">
		<input
			message      = "Specify a branch or set mw.branch in local.properties"
			defaultvalue = "trunk"
			addproperty  = "mw.branch"
		/>
	</target>


	<target name="build" depends="install" description="Main entry point" />

	<target name="install" depends="clean,create-dirs,installdb">
		<!-- Append a call to extrasettings -->
		<echo level="info">Making MediaWiki to load ExtraSettings.php</echo>
		<echo append="true" file="${builddir}/LocalSettings.php">
<![CDATA[
# START: PHP code inserted automatically by build job

# Include ExtraSettings.php
if( file_exists( 'ExtraSettings.php' ) ) {
	require_once( 'ExtraSettings.php' );
} else {
	require_once( dirname( dirname( __FILE__ ) ) ) . '/ExtraSettings.php';
}
# END: PHP code inserted automatically by build job
]]>
		</echo>
		<echo level="info">Running MediaWiki update</echo>
		<exec executable="php" dir="${builddir}/" failonerror="true">
			<arg line="${sourcedir}/maintenance/update.php --quick --conf ${builddir}/LocalSettings.php" />
		</exec>
	</target>

	<target name="create-dirs">
		<echo level="info">Creating basic build directory tree</echo>
		<mkdir dir="${builddir}" />
		<mkdir dir="${builddir}/api" />
		<mkdir dir="${builddir}/data" />
		<mkdir dir="${builddir}/charts" />
		<mkdir dir="${builddir}/coverage" />
		<mkdir dir="${builddir}/dist" />
		<mkdir dir="${builddir}/logs" />
		<mkdir dir="${builddir}/php-code-browser" />
	</target>

	<!-- Database installation targets -->
	<target name="installdb" depends="select-database">
		<echo>Running MediaWiki installer for database ${mw.database}</echo>
		<antcall target="installdb-${mw.database}" />
	</target>
	<target name="installdb-mysql" depends="create-dirs,cleandb-mysql">
		<fail>Install not implemented for MySQL</fail>
	</target>
	<target name="installdb-postgre" depends="create-dirs,cleandb-postgre">
		<exec executable="php" dir="${builddir}/" failonerror="true">
			<arg line="${sourcedir}/maintenance/install.php
				--confpath ${builddir}
				--dbtype=postgres
				--dbname=${pgdb}
				--dbuser=wikiuser
				--dbpass='${pgpass}'
				--installdbuser=jenkins
				--installdbpass=jenkins
				--showexceptions=true
				--pass testpass
				postgrestest
				WikiAdmin
			"/>
		</exec>
	</target>
	<target name="installdb-sqlite" depends="create-dirs,cleandb-sqlite">
		<exec executable="php" dir="${builddir}/" failonerror="true">
			<arg line="${sourcedir}/maintenance/install.php
				--confpath ${builddir}
				--dbtype=sqlite
				--dbpath=${builddir}/data
				--showexceptions=true
				--pass testpass
				sqlitetest
				WikiAdmin
			"/>
		</exec>
	</target>

	<target name="fake-localsettings" depends="create-dirs">
		<touch file="${builddir}/LocalSettings.php" />
	</target>

	<target name="clean" depends="cleandb">
		<echo level="info">Deleting LocalSettings.php</echo>
		<delete file="${builddir}/LocalSettings.php" />
	</target>
	<!-- Database cleaning targets -->
	<target name="cleandb"
		depends="select-database"
		description="Clean database (set mw.database)">
		<echo>Cleaning database!</echo>
		<antcall target="cleandb-${mw.database}" />
	</target>
	<target name="cleandb-mysql">
		<echo>Cleaning MySQL!</echo>
		<fail>Database cleaning not implemented for MySQL</fail>
	</target>
	<target name="cleandb-postgre">
		<echo>Cleaning PostgreSQL!</echo>
		<exec executable="dropdb">
			<arg line="-e ${pgdb}" />
		</exec>
	</target>
	<target name="cleandb-sqlite">
		<echo>Cleaning SQLite!</echo>
		<delete file="${builddir}/data/my_wiki.sqlite" />
	</target>

	<target name="-import-gerrit-env"
		description="Import env variables set by Jenkins Gerrit trigger">
		<fail>
			<condition>
				<not><and>
					<!-- only checking criticals variables for now -->
					<isset property="env.GERRIT_BRANCH" />
					<isset property="env.GERRIT_CHANGE_NUMBER" />
					<isset property="env.GERRIT_PATCHSET_NUMBER" />
				</and></not>
			</condition>
Requires some Gerrit environnement to be set, usually through the Gerrit trigger plugin.
Something must be wrong, when running from CLI, you should at least
set the following environnement variables:
- GERRIT_BRANCH
- GERRIT_CHANGE_NUMBER
- GERRIT_PATCHSET_NUMBER
		</fail>
		<echo>Importing Gerrit environnement as ant variables...</echo>
		<property name="gerrit.branch"                  value="${env.GERRIT_BRANCH}" />
		<property name="gerrit.change.number"           value="${env.GERRIT_CHANGE_NUMBER}" />
		<property name="gerrit.change.id"               value="${env.GERRIT_CHANGE_ID}" />
		<property name="gerrit.patchset.number"         value="${env.GERRIT_PATCHSET_NUMBER}" />
		<property name="gerrit.patchset.revision"       value="${env.GERRIT_PATCHSET_REVISION}" />
		<property name="gerrit.refspec"                 value="${env.GERRIT_REFSPEC}" />
		<property name="gerrit.project"                 value="${env.GERRIT_PROJECT}" />
		<property name="gerrit.change.subject"          value="${env.GERRIT_CHANGE_SUBJECT}" />
		<property name="gerrit.change.url"              value="${env.GERRIT_CHANGE_URL}" />
		<property name="gerrit.change.owner"            value="${env.GERRIT_CHANGE_OWNER}" />
		<property name="gerrit.change.owner.name"       value="${env.GERRIT_CHANGE_OWNER_NAME}" />
		<property name="gerrit.change.owner.email"      value="${env.GERRIT_CHANGE_OWNER_EMAIL}" />
		<property name="gerrit.patchset.uploader"       value="${env.GERRIT_PATCHSET_UPLOADER}" />
		<property name="gerrit.patchset.uploader.name"  value="${env.GERRIT_PATCHSET_UPLOADER_NAME}" />
		<property name="gerrit.patchset.uploader.email" value="${env.GERRIT_PATCHSET_UPLOADER_EMAIL}" />
		<!-- Dump properties defined just above: -->
		<echoproperties prefix="gerrit." />
	</target>

	<!-- Takes a copy of a MediaWiki install -->
	<target name="testswarm-snapshot" depends="-import-gerrit-env,install">
		<fail>
			<condition>
			<not><and>
				<isset property="gerrit.change.number" />
				<isset property="gerrit.patchset.number" />
			</and></not>
			</condition>
			This ant target requires both GERRIT_CHANGE_NUMBER and GERRIT_PATCHSET_NUMBER environnement variables to be set or at least their ant equivalents `gerrit.change.number` and `gerrit.patchset.number`.
		</fail>

		<!-- some testswarm specific properties depending on gerrit context -->
		<property
			name="changePath"
			value="${gerrit.change.number}/${gerrit.patchset.number}" />
		<property
			name="testswarm.publicdir"
			value="${testswarm.basedir}/clone/${changePath}" />
		<property
			name="testswarm.sqlite.dir"
			value="${testswarm.basedir}/db/${changePath}" />
		<property
			name="testswarm.sqlite.file"
			value="${testswarm.sqlite.dir}/my_wiki.sqlite" />
		<!-- Dump properties defined just above: -->
		<echoproperties prefix="testswarm." />

		<!-- create various directories -->
		<mkdir dir="${testswarm.sqlite.dir}" />
		<mkdir dir="${testswarm.publicdir}" />
<!--
		<mkdir dir="${testswarm.basedir}/conf" />
		<mkdir dir="${testswarm.basedir}/log" />
-->
		<!-- apply "sane" permissions to files in the base directory -->
		<chmod perm="2775">
			<dirset dir="${testswarm.basedir}">
				<include name="*" />
			</dirset>
		</chmod>
		<!-- the `db` path need to be in the www-data group. That is done by puppet -->

		<!-- Snapshot the sqlite database -->
		<echo>Copying sqlite database</echo>
		<copy
			file="${builddir}/data/my_wiki.sqlite"
			tofile="${testswarm.sqlite.file}"
			/>
		<!-- Both sqlite file and directory need to be writable by apache -->
		<!-- FIXME!! www-data should be enforced by g+s already :-(  -->
		<chmod perm="go+w" dir="${testswarm.sqlite.dir}" />
		<chmod perm="go+w" file="${testswarm.sqlite.file}" />

		<!-- Snapshot MediaWiki files -->
		<!-- FIXME: this should most probably uses `git clone` -->
		<echo>Publishing MediaWiki files</echo>
		<copy todir="${testswarm.publicdir}">
			<fileset dir="${sourcedir}">
				<exclude name="**/.git/" />
			</fileset>
		</copy>

		<echo>Copying LocalSettings.php</echo>
		<copy
			file="${builddir}/LocalSettings.php"
			todir="${testswarm.publicdir}"
		/>
		<echo>Copying ExtraSettings.php</echo>
		<copy
			file="${basedir}/ExtraSettings.php"
			todir="${testswarm.publicdir}"
		/>

		<echo>Tweaking configuration</echo>
		<!-- TODO actually copy the ExtraSettings file -->

		<!-- Property containing the URL path -->
		<property name="testswarm.URL.path"
			value="${testswarm.URL.basepath}/${changePath}" />

		<replace file="${testswarm.publicdir}/LocalSettings.php">
			<!-- Replace $wgServer value -->
			<replacefilter
				token="http://localhost"
				value="${testswarm.URL.scheme}${testswarm.URL.authority}"
			/>
		<replacefilter>
			<replacetoken><![CDATA[$wgScriptPath       = "/wiki";]]></replacetoken>
			<replacevalue expandProperties="true"><![CDATA[$wgScriptPath       = "${testswarm.URL.path}";]]></replacevalue>
		</replacefilter>
		<replacefilter>
			<replacetoken expandProperties="true">${builddir}/data</replacetoken>
			<replacevalue expandProperties="true">${testswarm.sqlite.dir}</replacevalue>
		</replacefilter>
		</replace>

		<!-- TODO: alter extrasettings.php? -->
	</target>

	<!-- Submit a job to TestSwarm -->
	<target name="testswarm-submitjob" depends="testswarm-snapshot">
		<echo>Attempting submission to TestSwarm</echo>
		<exec executable="php" dir="${testswarm.submit.path}" failonerror="true">
			<arg line="${testswarm.submit.script}" />
			<arg line="--change   ${gerrit.change.number}" />
			<arg line="--patchset ${gerrit.patchset.number}" />
			<arg line="--commit   ${gerrit.patchset.revision}" />
		</exec>
	</target>

	<!-- PHPUnit related targets -->
	<target name="phpunit-databaseless" depends="fake-localsettings">
		<run-phpunit options="--exclude-group Database,${phpunitexcludes}" />
	</target>

	<target name="phpunit-databased" depends="phpunit-parser, phpunit-api, phpunit-dump" />

	<!-- Sub targets, whenever you add a new group, make sure to also have
	     it excluded from the phpunit-misc job
	     -->
	<target name="phpunit-dump" depends="installdb">
		<run-phpunit options="--group Dump --exclude-group ${phpunitexcludes}"/>
	</target>
	<target name="phpunit-parser" depends="installdb">
		<run-phpunit options="--group Parser --exclude-group ${phpunitexcludes}"/>
	</target>
	<target name="phpunit-api" depends="installdb">
		<run-phpunit options="--group API --exclude-group ${phpunitexcludes}"/>
	</target>
	<!-- Exclude any group defined above:-->
	<target name="phpunit-misc" depends="installdb">
		<run-phpunit options="--group Database --exclude-group API,Dump,Parser,${phpunitexcludes}"/>
	</target>

	<!-- Macro to run some phpunit tests
	     @param Options Additional parameters to pass to PHPUnit
	-->
	<macrodef name="run-phpunit">
		<attribute name="options" default="" />

		<sequential>
		<exec executable="php" dir="${sourcedir}/tests/phpunit" failonerror="true">
			<arg line="phpunit.php --conf ${builddir}/LocalSettings.php @{options} --log-junit ${builddir}/logs/junit.xml" />
		</exec>
		</sequential>
	</macrodef>

	<target name="git-files-changed">
		<exec executable="git" dir="${sourcedir}" failonerror="true"
			outputproperty="gitfileschanged">
			<arg line="diff --name-only HEAD^" />
		</exec>
		<echo>Files changed according to git:</echo>
		<echo>${gitfileschanged}</echo>
		<!-- Create a new property with only php files: -->
		<exec executable="grep"
			inputstring="${gitfileschanged}"
			outputproperty="gitphpfileschanged">
			<arg value="-E" />
			<arg value="'\.(php|php5|inc|phtml)$'" />
			</exec>

		<!-- Create a new property without newlines: -->
		<exec executable="tr"
			inputstring="${gitfileschanged}"
			outputproperty="gitfileschangedinline">
			<arg value="\n" />
			<arg value=" " />
			</exec>
	</target>

	<!-- A very very basic linter using `php -l` -->
	<!-- FIXME: find a way to limit list of files to *.php *.inc *.phtml *.php5 -->
	<target name="php-lint" depends="git-files-changed">
		<echo>Blindly running `php -l` on all modified files</echo>
		<apply
			executable="php"
			relative="true"
			dir="${sourcedir}"
			failonerror="true"
			verbose="true"
		>
			<arg value="-l" />
			<filelist dir="${sourcedir}" files="${gitphpfileschanged}" />
		</apply>
	</target>

	<!-- check code style on files changed by HEAD -->
	<target name="checkstyle" depends="create-dirs,git-files-changed">
		<echo>Running PHP CodeSniffer in ${sourcedir}</echo>
		<!--
				Must have git-files-changed target executed before.
				The target will generate gitfileschangedinline property
				which list all modified files on a single line
		-->
		<exec executable="phpcs" dir="${sourcedir}" output="${builddir}/logs/checkstyle.xml">
			<arg line="--report=checkstyle --standard=../../../tools/MediaWiki-CodeSniffer/MediaWiki --ignore='Messages*.php,*.css,*.js' ${gitfileschangedinline}"/>
		</exec>
		<echo>PHP CodeSniffer apparently finished analysis.</echo>
	</target>
</project>
