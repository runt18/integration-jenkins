<?xml version="1.0" encoding="UTF-8" ?>
<!--
	ant build file for MediaWiki Core continuous integration
-->
<project name="MediaWiki" default="build">

	<!-- Import environnement: -->
	<property environment="env" />

	<property name="phpunitexcludes" value="Broken,ParserFuzz,Stub" />

	<!-- Import generic settings and validate existance -->

	<!-- private.properties for password. it is in .gitignore -->
	<property file="private.properties" />

	<!-- job.properties file is at the job level. Useful to override generic
		 properties -->
	<property file="job.properties" />

	<!-- then load the default.properties, setting any values which have not been
	     set previously -->
	<property file="default.properties" />

	<fail unless="sourcedir">You must define sourcedir</fail>
	<fail unless="builddir" >You must define builddir</fail>

	<!-- ant -Dmw.database=sqlite -->
	<target name="select-database" unless="mw.database">
		<input
			message      = "Select a database backend or set mw.database in local.properties"
			validargs    = "sqlite, postgre, mysql"
			defaultvalue = "sqlite"
			addproperty  = "mw.database"
		/>
	</target>
	<target name="select-branch" unless="mw.branch">
		<input
			message      = "Specify a branch or set mw.branch in local.properties"
			defaultvalue = "trunk"
			addproperty  = "mw.branch"
		/>
	</target>


	<target name="build" depends="install" description="Main entry point" />

	<target name="install" depends="clean,create-dirs,installdb">
		<!-- Append a call to extrasettings -->
		<echo level="info">Making MediaWiki to load ExtraSettings.php</echo>
		<echo append="true" file="${builddir}/LocalSettings.php">
<![CDATA[
# START: PHP code inserted automatically by build job

# Include ExtraSettings.php
require_once( dirname( dirname( __FILE__ ) ) ) . '/ExtraSettings.php';

# END: PHP code inserted automatically by build job
]]>
		</echo>
		<echo level="info">Running MediaWiki update</echo>
		<exec executable="php" dir="${builddir}/" failonerror="true">
			<arg line="${sourcedir}/maintenance/update.php --quick --conf ${builddir}/LocalSettings.php" />
		</exec>
	</target>

	<target name="create-dirs">
		<echo level="info">Creating basic build directory tree</echo>
		<mkdir dir="${builddir}" />
		<mkdir dir="${builddir}/api" />
		<mkdir dir="${builddir}/data" />
		<mkdir dir="${builddir}/charts" />
		<mkdir dir="${builddir}/coverage" />
		<mkdir dir="${builddir}/dist" />
		<mkdir dir="${builddir}/logs" />
		<mkdir dir="${builddir}/php-code-browser" />
	</target>

	<!-- Database installation targets -->
	<target name="installdb" depends="select-database">
		<echo>Running MediaWiki installer for database ${mw.database}</echo>
		<antcall target="installdb-${mw.database}" />
	</target>
	<target name="installdb-mysql" depends="create-dirs,cleandb-mysql">
		<fail>Install not implemented for MySQL</fail>
	</target>
	<target name="installdb-postgre" depends="create-dirs,cleandb-postgre">
		<exec executable="php" dir="${builddir}/" failonerror="true">
			<arg line="${sourcedir}/maintenance/install.php
				--confpath ${builddir}
				--dbtype=postgres
				--dbname=${pgdb}
				--dbuser=wikiuser
				--dbpass='${pgpass}'
				--installdbuser=jenkins
				--installdbpass=jenkins
				--showexceptions=true
				--pass testpass
				postgrestest
				WikiAdmin
			"/>
		</exec>
	</target>
	<target name="installdb-sqlite" depends="create-dirs,cleandb-sqlite">
		<exec executable="php" dir="${builddir}/" failonerror="true">
			<arg line="${sourcedir}/maintenance/install.php
				--confpath ${builddir}
				--dbtype=sqlite
				--dbpath=${builddir}/data
				--showexceptions=true
				--pass testpass
				sqlitetest
				WikiAdmin
			"/>
		</exec>
	</target>

	<target name="fake-localsettings" depends="create-dirs">
		<touch file="${builddir}/LocalSettings.php" />
	</target>

	<target name="clean" depends="cleandb">
		<echo level="info">Deleting LocalSettings.php</echo>
		<delete file="${builddir}/LocalSettings.php" />
	</target>
	<!-- Database cleaning targets -->
	<target name="cleandb"
		depends="select-database"
		description="Clean database (set mw.database)">
		<echo>Cleaning database!</echo>
		<antcall target="cleandb-${mw.database}" />
	</target>
	<target name="cleandb-mysql">
		<echo>Cleaning MySQL!</echo>
		<fail>Database cleaning not implemented for MySQL</fail>
	</target>
	<target name="cleandb-postgre">
		<echo>Cleaning PostgreSQL!</echo>
		<exec executable="dropdb">
			<arg line="-e ${pgdb}" />
		</exec>
	</target>
	<target name="cleandb-sqlite">
		<echo>Cleaning SQLite!</echo>
		<delete file="${builddir}/data/my_wiki.sqlite" />
	</target>

	<!-- PHPUnit related targets -->
	<target name="phpunit-databaseless" depends="fake-localsettings">
		<run-phpunit options="--exclude-group Database,${phpunitexcludes}" />
	</target>

	<target name="phpunit-databased" depends="phpunit-parser, phpunit-api, phpunit-dump" />

	<!-- Sub targets, whenever you add a new group, make sure to also have
	     it excluded from the phpunit-misc job
	     -->
	<target name="phpunit-dump" depends="installdb">
		<run-phpunit options="--group Dump --exclude-group ${phpunitexcludes}"/>
	</target>
	<target name="phpunit-parser" depends="installdb">
		<run-phpunit options="--group Parser --exclude-group ${phpunitexcludes}"/>
	</target>
	<target name="phpunit-api" depends="installdb">
		<run-phpunit options="--group API --exclude-group ${phpunitexcludes}"/>
	</target>
	<!-- Exclude any group defined above:-->
	<target name="phpunit-misc" depends="installdb">
		<run-phpunit options="--group Database --exclude-group API,Dump,Parser,${phpunitexcludes}"/>
	</target>

	<!-- Macro to run some phpunit tests
	     @param Options Additional parameters to pass to PHPUnit
	-->
	<macrodef name="run-phpunit">
		<attribute name="options" default="" />

		<sequential>
		<exec executable="php" dir="${sourcedir}/tests/phpunit" failonerror="true">
			<arg line="phpunit.php --conf ${builddir}/LocalSettings.php @{options} --log-junit ${builddir}/logs/junit.xml" />
		</exec>
		</sequential>
	</macrodef>

	<target name="git-files-changed">
		<exec executable="git" dir="${sourcedir}" failonerror="true"
			outputproperty="gitfileschanged">
			<arg line="diff --name-only HEAD^" />
		</exec>
		<echo>Files changed according to git:</echo>
		<echo>${gitfileschanged}</echo>
		<!-- Create a new property without newlines: -->
		<exec executable="tr"
			inputstring="${gitfileschanged}"
			outputproperty="gitfileschangedinline">
			<arg value="\n" />
			<arg value=" " />
			</exec>
	</target>

	<!-- check code style on files changed by HEAD -->
	<target name="checkstyle" depends="create-dirs,git-files-changed">
		<echo>Running PHP CodeSniffer in ${sourcedir}</echo>
		<!--
				Must have git-files-changed target executed before.
				The target will generate gitfileschangedinline property
				which list all modified files on a single line
		-->
		<exec executable="phpcs" dir="${sourcedir}" output="${builddir}/logs/checkstyle.xml">
			<arg line="--report=checkstyle --standard=PEAR --ignore='Messages*.php,*.css,*.js' ${gitfileschangedinline}"/>
		</exec>
		<echo>PHP CodeSniffer apparently finished analysis.</echo>
	</target>
</project>
